<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#FF6B00">
<title>RealBattle ‚Äî Home</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:#07070f;min-height:100vh;font-family:'Rajdhani',sans-serif;color:#fff;
  overflow-x:hidden;padding-bottom:80px;}
/* header */
.hdr{background:rgba(7,7,15,.9);padding:44px 16px 12px;display:flex;
  justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:40;backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.05);}
.logo-s{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:4px;
  color:#FF6B00;text-shadow:0 0 20px rgba(255,107,0,.5);}
.coins{background:#111122;border:1px solid rgba(255,107,0,.3);border-radius:20px;
  padding:7px 14px;font-size:14px;font-weight:700;color:#FF6B00;}
/* player card */
.pcard{margin:14px;padding:18px;
  background:linear-gradient(135deg,#0f0f1e,#1a1a30);
  border:1px solid rgba(255,255,255,.06);border-radius:18px;
  display:flex;align-items:center;gap:14px;position:relative;overflow:hidden;}
.pcard::before{content:'';position:absolute;left:0;top:0;width:3px;height:100%;
  background:linear-gradient(180deg,#FF6B00,#FF4500);}
.ava{width:60px;height:60px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(135deg,#FF6B00,#FF4500);
  display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;
  box-shadow:0 4px 20px rgba(255,107,0,.4);}
.pn{font-size:20px;font-weight:700;letter-spacing:1px;}
.pl{color:#555;font-size:12px;margin-top:2px;}
.pst{display:flex;gap:20px;margin-top:8px;}
.ps .n{font-size:18px;font-weight:700;color:#FF6B00;}
.ps .l{font-size:9px;color:#555;letter-spacing:1px;}
/* section */
.stitle{padding:0 16px;font-size:10px;letter-spacing:4px;color:#444;margin:16px 0 10px;font-weight:600;}
/* cards */
.cards{padding:0 14px;display:flex;flex-direction:column;gap:10px;margin-bottom:8px;}
.mc{background:#0f0f1c;border:1px solid rgba(255,255,255,.05);
  border-radius:15px;padding:16px;display:flex;align-items:center;gap:14px;
  cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.mc:active{transform:scale(.98);background:#141424;}
.mc.hot{border-color:rgba(255,107,0,.4);background:linear-gradient(135deg,rgba(255,107,0,.1),rgba(255,69,0,.05));}
.mi{width:52px;height:52px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;}
.mi.o{background:linear-gradient(135deg,#FF6B00,#FF4500);}
.mi.b{background:linear-gradient(135deg,#0055cc,#0077ff);}
.minfo h3{font-size:17px;font-weight:700;letter-spacing:1px;}
.minfo p{color:#555;font-size:12px;margin-top:3px;}
.mbdg{position:absolute;right:14px;top:50%;transform:translateY(-50%);
  background:#FF6B00;color:#fff;font-size:10px;font-weight:700;
  padding:4px 10px;border-radius:20px;letter-spacing:1px;}
.mbdg.g{background:#222;color:#444;}
/* bottom nav */
.bnav{position:fixed;bottom:0;left:0;right:0;
  background:rgba(7,7,15,.95);border-top:1px solid rgba(255,255,255,.05);
  display:flex;padding:8px 0 20px;backdrop-filter:blur(20px);z-index:50;}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:7px 0;cursor:pointer;transition:all .15s;}
.ni:active{transform:scale(.9);}
.ni-i{font-size:22px;}
.ni-l{font-size:9px;color:#444;letter-spacing:1px;font-weight:600;}
.ni.on .ni-l{color:#FF6B00;}
/* modal backdrop */
.modal{display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.9);backdrop-filter:blur(12px);
  flex-direction:column;align-items:center;justify-content:flex-end;}
.modal.show{display:flex;}
.sheet{width:100%;max-width:500px;background:#0d0d1c;
  border-radius:24px 24px 0 0;padding:22px 16px 36px;
  border-top:1px solid rgba(255,255,255,.07);animation:sup .3s ease;}
@keyframes sup{from{transform:translateY(100%);}to{transform:translateY(0);}}
.sht{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;color:#FF6B00;margin-bottom:4px;}
.ssb{color:#555;font-size:12px;margin-bottom:18px;letter-spacing:1px;}
/* mode grid */
.mgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:18px;}
.mb{background:#1a1a2a;border:1px solid rgba(255,255,255,.06);border-radius:12px;
  padding:15px;text-align:center;cursor:pointer;transition:all .15s;}
.mb:active{transform:scale(.95);}
.mb.sel{border-color:#FF6B00;background:rgba(255,107,0,.15);}
.mb-lbl{font-size:20px;font-weight:700;color:#FF6B00;}
.mb-sub{font-size:10px;color:#555;margin-top:2px;letter-spacing:1px;}
.btn-go{width:100%;padding:17px;background:linear-gradient(135deg,#FF6B00,#FF4500);
  border:none;border-radius:13px;color:#fff;font-family:'Rajdhani',sans-serif;
  font-size:17px;font-weight:700;letter-spacing:3px;cursor:pointer;
  box-shadow:0 6px 25px rgba(255,107,0,.4);transition:all .15s;}
.btn-go:active{transform:scale(.97);}
.btn-cl{width:100%;padding:13px;background:none;border:1px solid #222;
  border-radius:12px;color:#555;font-family:'Rajdhani',sans-serif;
  font-size:14px;cursor:pointer;margin-top:8px;letter-spacing:2px;}
/* waiting */
.wait{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.95);
  flex-direction:column;align-items:center;justify-content:center;gap:18px;}
.wait.show{display:flex;}
.wspn{width:88px;height:88px;border:3px solid #1a1a2a;border-top:3px solid #FF6B00;
  border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.wtxt{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:6px;color:#FF6B00;}
.wbox{background:#111122;border:1px solid rgba(255,255,255,.06);
  border-radius:14px;padding:16px 30px;text-align:center;}
.wct{font-size:34px;font-weight:700;color:#FF6B00;}
.wof{font-size:11px;color:#555;letter-spacing:2px;}
/* store */
.slist{display:flex;flex-direction:column;gap:8px;max-height:65vh;overflow-y:auto;padding-bottom:8px;}
.si{background:#1a1a2a;border:1px solid rgba(255,255,255,.05);
  border-radius:13px;padding:13px;display:flex;align-items:center;gap:12px;}
.si.eq{border-color:rgba(255,107,0,.45);background:rgba(255,107,0,.08);}
.si-ic{font-size:26px;flex-shrink:0;}
.si-info{flex:1;}
.si-n{font-size:15px;font-weight:700;}
.si-t{font-size:10px;color:#555;letter-spacing:1px;}
.si-st{font-size:11px;color:#444;margin-top:2px;}
.eq-btn{border:none;border-radius:9px;padding:8px 14px;
  font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;
  cursor:pointer;letter-spacing:1px;flex-shrink:0;}
.eq-btn.add{background:linear-gradient(135deg,#FF6B00,#FF4500);color:#fff;}
.eq-btn.rem{background:rgba(255,107,0,.15);color:#FF6B00;border:1px solid rgba(255,107,0,.3);}
.frow{display:flex;gap:7px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px;}
.fb{padding:6px 14px;border-radius:18px;background:#1a1a2a;border:1px solid rgba(255,255,255,.06);
  color:#555;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;
  cursor:pointer;white-space:nowrap;letter-spacing:1px;flex-shrink:0;}
.fb.on{background:rgba(255,107,0,.2);border-color:#FF6B00;color:#FF6B00;}
/* headshot toggle */
.hst{margin:0 14px 14px;padding:15px;background:#0f0f1c;
  border:1px solid rgba(255,255,255,.05);border-radius:14px;
  display:flex;align-items:center;justify-content:space-between;}
.hs-info h4{font-size:15px;font-weight:700;}
.hs-info p{font-size:11px;color:#555;margin-top:2px;}
.sw{width:50px;height:27px;background:#1a1a2a;border-radius:14px;
  position:relative;cursor:pointer;transition:background .3s;border:1px solid #333;}
.sw.on{background:linear-gradient(135deg,#FF6B00,#FF4500);border-color:#FF6B00;}
.swk{position:absolute;top:3px;left:3px;width:19px;height:19px;background:#fff;
  border-radius:50%;transition:transform .3s;box-shadow:0 2px 6px rgba(0,0,0,.5);}
.sw.on .swk{transform:translateX(23px);}
</style>
</head>
<body>
<div class="hdr">
  <div class="logo-s">‚öî REALBATTLE</div>
  <div class="coins">üí∞ <span id="cd">0</span></div>
</div>

<div class="pcard">
  <div class="ava" id="ava">?</div>
  <div>
    <div class="pn" id="pn">Loading...</div>
    <div class="pl" id="pl">Level 1</div>
    <div class="pst">
      <div class="ps"><div class="n" id="sm">0</div><div class="l">MATCHES</div></div>
      <div class="ps"><div class="n" id="sw2">0</div><div class="l">WINS</div></div>
      <div class="ps"><div class="n" id="sk">0</div><div class="l">KILLS</div></div>
    </div>
  </div>
</div>

<div class="hst">
  <div class="hs-info">
    <h4>üéØ Headshot Mode</h4>
    <p id="hsp">ON ‚Äî Head pe aim karo extra damage ke liye</p>
  </div>
  <div class="sw on" id="hstgl" onclick="toggleHS()"><div class="swk"></div></div>
</div>

<p class="stitle">GAME MODES</p>
<div class="cards">
  <div class="mc hot" onclick="openMode()">
    <div class="mi o">‚öîÔ∏è</div>
    <div class="minfo"><h3>START BATTLE</h3><p>1v1 to 4v4 ¬∑ AR Camera ¬∑ Real World</p></div>
    <div class="mbdg">PLAY</div>
  </div>
  <div class="mc" onclick="openStore()">
    <div class="mi b">üî´</div>
    <div class="minfo"><h3>GUN STORE</h3><p>3 guns equip karo battle ke liye</p></div>
    <div class="mbdg" style="background:#0055cc">STORE</div>
  </div>
</div>

<div class="bnav">
  <div class="ni on"><span class="ni-i">üè†</span><span class="ni-l">HOME</span></div>
  <div class="ni" onclick="openStore();tap();vib(20)"><span class="ni-i">üî´</span><span class="ni-l">WEAPONS</span></div>
  <div class="ni" onclick="doLogout()"><span class="ni-i">‚öôÔ∏è</span><span class="ni-l">LOGOUT</span></div>
</div>

<!-- Mode Modal -->
<div class="modal" id="modM">
  <div style="flex:1" onclick="closeMode()"></div>
  <div class="sheet">
    <div class="sht">SELECT MODE</div>
    <div class="ssb">Team format choose karo</div>
    <div class="mgrid" id="mgrid"></div>
    <button class="btn-go" onclick="startSearch()">‚öî FIND MATCH</button>
    <button class="btn-cl" onclick="closeMode()">‚úï CANCEL</button>
  </div>
</div>

<!-- Waiting -->
<div class="wait" id="waitOvl">
  <div class="wspn"></div>
  <div class="wtxt">FINDING PLAYERS</div>
  <div class="wbox">
    <div class="wct"><span id="wh">1</span> / <span id="wn">2</span></div>
    <div class="wof">PLAYERS JOINED</div>
  </div>
  <div style="color:#444;font-size:12px;letter-spacing:2px" id="wsub">Searching...</div>
  <button class="btn-cl" style="width:200px;margin-top:8px" onclick="cancelSearch()">‚úï CANCEL</button>
</div>

<!-- Store Modal -->
<div class="modal" id="storeM">
  <div style="flex:1" onclick="closeStore()"></div>
  <div class="sheet" style="max-height:88vh;overflow:hidden;display:flex;flex-direction:column;">
    <div class="sht">GUN STORE</div>
    <div class="ssb" id="ssub">3 guns equipped. All guns FREE.</div>
    <div class="frow" id="frow"></div>
    <div class="slist" id="slist"></div>
    <button class="btn-cl" onclick="closeStore()" style="margin-top:10px;flex-shrink:0">‚úï CLOSE</button>
  </div>
</div>

<script>
let PD = null, selMode = null, eqGuns = [], hsOn = true;
let srchCh = null, srchInt = null, roomId = null, sfilt = 'All';

window.addEventListener('load', async () => {
  const {data:{session}} = await supabase.auth.getSession();
  if (!session) { window.location.href='index.html'; return; }
  localStorage.setItem('rb_uid', session.user.id);
  const {data} = await supabase.from('players').select('*').eq('id',session.user.id).single();
  if (!data) { window.location.href='index.html'; return; }
  PD = data;
  localStorage.setItem('rb_un', data.username);
  eqGuns = data.selected_guns || ['desert','m1887','ump'];
  hsOn = data.headshot_on !== false;
  renderP(); buildModes(); updHS();
});

function renderP() {
  document.getElementById('pn').textContent = PD.username.toUpperCase();
  document.getElementById('ava').textContent = PD.username[0].toUpperCase();
  document.getElementById('pl').textContent = 'Level ' + PD.level + ' ¬∑ RealBattle India';
  document.getElementById('sm').textContent = PD.total_matches||0;
  document.getElementById('sw2').textContent = PD.wins||0;
  document.getElementById('sk').textContent = PD.kills||0;
  document.getElementById('cd').textContent = PD.coins||0;
}

function toggleHS() {
  tap();vib(30); hsOn=!hsOn; updHS();
  supabase.from('players').update({headshot_on:hsOn}).eq('id',PD.id);
}
function updHS() {
  const t=document.getElementById('hstgl');
  t.classList.toggle('on',hsOn);
  document.getElementById('hsp').textContent = hsOn
    ? 'ON ‚Äî Head pe aim karo extra damage ke liye'
    : 'OFF ‚Äî Body shots only';
}

function buildModes() {
  const g=document.getElementById('mgrid'); g.innerHTML='';
  MODES.forEach(m=>{
    const d=document.createElement('div');
    d.className='mb'+(selMode?.id===m.id?' sel':'');
    d.innerHTML=`<div class="mb-lbl">${m.label}</div><div class="mb-sub">${m.total} players</div>`;
    d.onclick=()=>{ tap();vib(20); selMode=m; buildModes(); };
    g.appendChild(d);
  });
}

function openMode(){tap();vib(25);document.getElementById('modM').classList.add('show');}
function closeMode(){tap();document.getElementById('modM').classList.remove('show');}

async function startSearch() {
  if (!selMode) { alert('Mode select karo!'); return; }
  tap();vib([50,30,50]); closeMode();
  roomId = 'rb_'+Date.now()+'_'+Math.random().toString(36).slice(2,5);

  // Find existing waiting room
  const {data:rooms} = await supabase.from('rooms')
    .select('*').eq('mode',selMode.id).eq('status','waiting')
    .lt('player_count',selMode.total)
    .order('created_at',{ascending:true}).limit(1);

  if (rooms && rooms.length > 0) {
    roomId = rooms[0].room_id;
    await supabase.from('rooms').update({player_count:rooms[0].player_count+1}).eq('room_id',roomId);
  } else {
    await supabase.from('rooms').insert({
      room_id:roomId, mode:selMode.id,
      total_needed:selMode.total, player_count:1, status:'waiting'
    });
  }

  // Assign team
  const {data:rps} = await supabase.from('room_players').select('team').eq('room_id',roomId);
  const t1c = (rps||[]).filter(p=>p.team===1).length;
  const myTeam = t1c < selMode.t1 ? 1 : 2;

  await supabase.from('room_players').insert({
    room_id:roomId, player_id:PD.id, username:PD.username,
    team:myTeam, equipped_guns:eqGuns, hp:500, alive:true
  });

  document.getElementById('wn').textContent = selMode.total;
  document.getElementById('wh').textContent = rps ? rps.length+1 : 1;
  document.getElementById('waitOvl').classList.add('show');

  // Watch for room fill
  srchCh = supabase.channel('room_'+roomId)
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'rooms',
      filter:'room_id=eq.'+roomId}, async p => {
        const r = p.new;
        document.getElementById('wh').textContent = r.player_count;
        if (r.player_count >= r.total_needed) {
          clearInterval(srchInt);
          supabase.removeChannel(srchCh);
          await supabase.from('rooms').update({status:'active'}).eq('room_id',roomId);
          vib([100,50,100]);
          goGame(myTeam);
        }
    }).subscribe();

  srchInt = setInterval(async () => {
    const {data:r} = await supabase.from('rooms').select('player_count').eq('room_id',roomId).maybeSingle();
    if (r) document.getElementById('wh').textContent = r.player_count;
    const dots = '.'.repeat((Date.now()/700|0)%4);
    document.getElementById('wsub').textContent = 'Searching' + dots;
  }, 1500);
}

async function cancelSearch() {
  tap(); clearInterval(srchInt);
  if (srchCh) supabase.removeChannel(srchCh);
  if (roomId) {
    await supabase.from('room_players').delete().eq('room_id',roomId).eq('player_id',PD.id);
    const {data:r} = await supabase.from('rooms').select('player_count').eq('room_id',roomId).maybeSingle();
    if (r) {
      if (r.player_count <= 1) await supabase.from('rooms').delete().eq('room_id',roomId);
      else await supabase.from('rooms').update({player_count:r.player_count-1}).eq('room_id',roomId);
    }
  }
  document.getElementById('waitOvl').classList.remove('show');
}

function goGame(team) {
  localStorage.setItem('rb_room', roomId);
  localStorage.setItem('rb_mode', JSON.stringify(selMode));
  localStorage.setItem('rb_team', team);
  localStorage.setItem('rb_hs', hsOn?'1':'0');
  localStorage.setItem('rb_guns', JSON.stringify(eqGuns));
  window.location.href = 'game.html';
}

// STORE
function openStore() { tap();vib(25); buildStore('All'); document.getElementById('storeM').classList.add('show'); }
function closeStore() {
  tap(); document.getElementById('storeM').classList.remove('show');
  supabase.from('players').update({selected_guns:eqGuns}).eq('id',PD.id);
}

function buildStore(filt) {
  sfilt=filt;
  const types=['All','Pistol','Shotgun','AR','SMG','Sniper','Special'];
  const fr=document.getElementById('frow'); fr.innerHTML='';
  types.forEach(t=>{
    const b=document.createElement('button');b.className='fb'+(t===filt?' on':'');
    b.textContent=t; b.onclick=()=>{tap();buildStore(t);}; fr.appendChild(b);
  });
  document.getElementById('ssub').textContent = `Equipped: ${eqGuns.length}/3 guns (tap to add/remove)`;
  const sl=document.getElementById('slist'); sl.innerHTML='';
  GUN_LIST.forEach(gid=>{
    const g=GUNS[gid]; if(!g)return;
    if(filt!=='All'&&g.type!==filt)return;
    const isEq=eqGuns.includes(gid);
    const d=document.createElement('div');
    d.className='si'+(isEq?' eq':'');
    d.innerHTML=`
      <span class="si-ic">üî´</span>
      <div class="si-info">
        <div class="si-n">${g.name}</div>
        <div class="si-t">${g.type}</div>
        <div class="si-st">DMG:${g.dmg} | RANGE:${g.range}m | RATE:${(1/g.rate).toFixed(0)}/s | RELOAD:${g.reload}s</div>
      </div>
      <button class="eq-btn ${isEq?'rem':'add'}" onclick="toggleEq('${gid}',event)">
        ${isEq?'‚úì ON':'EQUIP'}
      </button>`;
    sl.appendChild(d);
  });
}

function toggleEq(gid,e) {
  e.stopPropagation();tap();vib(25);
  if(eqGuns.includes(gid)){
    if(eqGuns.length<=1){alert('Min 1 gun rakhni hai!');return;}
    eqGuns=eqGuns.filter(x=>x!==gid);
  } else {
    if(eqGuns.length>=3) eqGuns.shift();
    eqGuns.push(gid);
  }
  buildStore(sfilt);
}

async function doLogout() {
  tap();vib(20);
  if(!confirm('Logout?'))return;
  await supabase.auth.signOut(); localStorage.clear();
  window.location.href='index.html';
}
</script>
</body>
</html>

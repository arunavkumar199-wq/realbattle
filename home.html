<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1">
<meta name="theme-color" content="#FF6B00">
<title>RealBattle ‚Äî Home</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:linear-gradient(135deg,#0a0a1a 0%,#1a1a3a 100%);min-height:100vh;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#fff;
  overflow-x:hidden;padding-bottom:75px}
.hdr{background:rgba(10,10,25,0.95);padding:40px 14px 10px;display:flex;
  justify-content:space-between;align-items:center;position:sticky;top:0;z-index:40;
  backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.06)}
.logo-s{font-size:22px;font-weight:800;letter-spacing:2px;color:#ff6b00}
.coins{background:rgba(20,20,40,0.9);border:1px solid rgba(255,107,0,0.4);
  border-radius:18px;padding:6px 12px;font-size:13px;font-weight:700;color:#ff6b00}
.pcard{margin:12px;padding:16px;background:rgba(15,15,35,0.9);
  border:1px solid rgba(255,255,255,0.08);border-radius:16px;
  display:flex;align-items:center;gap:12px;position:relative}
.pcard::before{content:'';position:absolute;left:0;top:0;width:3px;height:100%;
  background:linear-gradient(180deg,#ff6b00,#ff4500);border-radius:16px 0 0 16px}
.ava{width:52px;height:52px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(135deg,#ff6b00,#ff4500);
  display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;
  box-shadow:0 4px 16px rgba(255,107,0,0.4)}
.pn{font-size:18px;font-weight:700;letter-spacing:0.5px}
.pl{color:#666;font-size:11px;margin-top:2px}
.pst{display:flex;gap:16px;margin-top:6px}
.ps .n{font-size:16px;font-weight:700;color:#ff6b00}
.ps .l{font-size:9px;color:#666;letter-spacing:0.5px}
.stitle{padding:0 14px;font-size:10px;letter-spacing:2px;color:#555;margin:14px 0 8px;font-weight:600;text-transform:uppercase}
.cards{padding:0 12px;display:flex;flex-direction:column;gap:8px}
.mc{background:rgba(15,15,35,0.9);border:1px solid rgba(255,255,255,0.07);
  border-radius:14px;padding:14px;display:flex;align-items:center;gap:12px;
  cursor:pointer;transition:all 0.15s}
.mc:active{transform:scale(0.99);background:rgba(20,20,45,0.95)}
.mc.hot{border-color:rgba(255,107,0,0.5);background:rgba(255,107,0,0.08)}
.mi{width:46px;height:46px;border-radius:11px;display:flex;align-items:center;
  justify-content:center;font-size:22px;flex-shrink:0}
.mi.o{background:linear-gradient(135deg,#ff6b00,#ff4500)}
.mi.b{background:linear-gradient(135deg,#0055cc,#0077ff)}
.minfo h3{font-size:16px;font-weight:700}
.minfo p{color:#666;font-size:11px;margin-top:2px}
.mbdg{margin-left:auto;background:#ff6b00;color:#fff;font-size:9px;font-weight:700;
  padding:3px 9px;border-radius:18px;letter-spacing:0.5px}
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,25,0.98);  border-top:1px solid rgba(255,255,255,0.06);display:flex;padding:6px 0 18px;
  backdrop-filter:blur(15px);z-index:50}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:6px 0;cursor:pointer}
.ni:active{transform:scale(0.95)}
.ni-i{font-size:20px}
.ni-l{font-size:9px;color:#666;font-weight:600}
.ni.on .ni-l{color:#ff6b00}
.modal{display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,0.92);backdrop-filter:blur(10px);
  flex-direction:column;align-items:center;justify-content:flex-end}
.modal.show{display:flex}
.sheet{width:100%;max-width:480px;background:rgba(13,13,28,0.98);
  border-radius:22px 22px 0 0;padding:18px 14px 28px;
  border-top:1px solid rgba(255,255,255,0.08)}
.sht{font-size:24px;font-weight:800;letter-spacing:2px;color:#ff6b00;margin-bottom:2px}
.ssb{color:#666;font-size:11px;margin-bottom:14px}
.mgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:14px}
.mb{background:rgba(26,26,48,0.9);border:1px solid rgba(255,255,255,0.07);
  border-radius:10px;padding:12px;text-align:center;cursor:pointer}
.mb:active{transform:scale(0.97)}
.mb.sel{border-color:#ff6b00;background:rgba(255,107,0,0.12)}
.mb-lbl{font-size:18px;font-weight:700;color:#ff6b00}
.mb-sub{font-size:9px;color:#666;margin-top:1px}
.btn-go{width:100%;padding:15px;background:linear-gradient(135deg,#ff6b00,#ff4500);
  border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:700;
  cursor:pointer;box-shadow:0 6px 20px rgba(255,107,0,0.35)}
.btn-go:active{transform:scale(0.98)}
.btn-cl{width:100%;padding:12px;background:rgba(30,30,50,0.9);border:1px solid rgba(255,255,255,0.1);
  border-radius:11px;color:#888;font-size:13px;cursor:pointer;margin-top:6px}
.wait{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.95);
  flex-direction:column;align-items:center;justify-content:center;gap:16px}
.wait.show{display:flex}
.wspn{width:70px;height:70px;border:3px solid rgba(255,255,255,0.1);
  border-top:3px solid #ff6b00;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.wtxt{font-size:24px;font-weight:800;letter-spacing:3px;color:#ff6b00}
.wbox{background:rgba(17,17,34,0.95);border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;padding:12px 24px;text-align:center}
.wct{font-size:28px;font-weight:700;color:#ff6b00}
.wof{font-size:10px;color:#666;letter-spacing:1px}
.slist{display:flex;flex-direction:column;gap:6px;max-height:55vh;overflow-y:auto}
.si{background:rgba(26,26,48,0.9);border:1px solid rgba(255,255,255,0.06);
  border-radius:11px;padding:11px;display:flex;align-items:center;gap:10px}
.si.eq{border-color:rgba(255,107,0,0.5);background:rgba(255,107,0,0.08)}
.si-ic{font-size:22px;flex-shrink:0}
.si-info{flex:1}
.si-n{font-size:14px;font-weight:700}
.si-t{font-size:9px;color:#666}
.si-st{font-size:10px;color:#555;margin-top:1px}.eq-btn{border:none;border-radius:8px;padding:6px 12px;
  font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0}
.eq-btn.add{background:linear-gradient(135deg,#ff6b00,#ff4500);color:#fff}
.eq-btn.rem{background:rgba(255,107,0,0.15);color:#ff6b00;border:1px solid rgba(255,107,0,0.3)}
.frow{display:flex;gap:5px;margin-bottom:10px;overflow-x:auto;padding-bottom:3px}
.fb{padding:5px 12px;border-radius:16px;background:rgba(26,26,48,0.9);
  border:1px solid rgba(255,255,255,0.08);color:#666;font-size:11px;font-weight:600;
  cursor:pointer;white-space:nowrap;flex-shrink:0}
.fb.on{background:rgba(255,107,0,0.2);border-color:#ff6b00;color:#ff6b00}
.hst{margin:0 12px 12px;padding:12px;background:rgba(15,15,35,0.9);
  border:1px solid rgba(255,255,255,0.07);border-radius:12px;
  display:flex;align-items:center;justify-content:space-between}
.hs-info h4{font-size:14px;font-weight:700}
.hs-info p{font-size:10px;color:#666;margin-top:1px}
.sw{width:44px;height:24px;background:rgba(26,26,48,0.9);border-radius:12px;
  position:relative;cursor:pointer;border:1px solid rgba(255,255,255,0.1)}
.sw.on{background:linear-gradient(135deg,#ff6b00,#ff4500);border-color:#ff6b00}
.swk{position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;
  border-radius:50%;transition:transform 0.25s}
.sw.on .swk{transform:translateX(20px)}
</style>
</head>
<body>
<div class="hdr">
  <div class="logo-s">‚öî REALBATTLE</div>
  <div class="coins">üí∞ <span id="cd">0</span></div>
</div>

<div class="pcard">
  <div class="ava" id="ava">?</div>
  <div>
    <div class="pn" id="pn">Loading...</div>
    <div class="pl" id="pl">Level 1</div>
    <div class="pst">
      <div class="ps"><div class="n" id="sm">0</div><div class="l">MATCHES</div></div>
      <div class="ps"><div class="n" id="sw2">0</div><div class="l">WINS</div></div>
      <div class="ps"><div class="n" id="sk">0</div><div class="l">KILLS</div></div>
    </div>
  </div>
</div>

<div class="hst">
  <div class="hs-info">
    <h4>üéØ Headshot Mode</h4>
    <p id="hsp">ON ‚Äî Aim head for 2x damage</p>
  </div>
  <div class="sw on" id="hstgl" onclick="toggleHS()"><div class="swk"></div></div>
</div>

<p class="stitle">GAME MODES</p><div class="cards">
  <div class="mc hot" onclick="openMode()">
    <div class="mi o">‚öîÔ∏è</div>
    <div class="minfo"><h3>START BATTLE</h3><p>1v1 to 4v4 ‚Ä¢ AR Camera ‚Ä¢ Real World</p></div>
    <div class="mbdg">PLAY</div>
  </div>
  <div class="mc" onclick="openStore()">
    <div class="mi b">üî´</div>
    <div class="minfo"><h3>GUN STORE</h3><p>Equip 3 guns for battle</p></div>
    <div class="mbdg" style="background:#0055cc">STORE</div>
  </div>
</div>

<div class="bnav">
  <div class="ni on"><span class="ni-i">üè†</span><span class="ni-l">HOME</span></div>
  <div class="ni" onclick="openStore();tap();vib(20)"><span class="ni-i">üî´</span><span class="ni-l">WEAPONS</span></div>
  <div class="ni" onclick="doLogout()"><span class="ni-i">‚öôÔ∏è</span><span class="ni-l">LOGOUT</span></div>
</div>

<!-- Mode Modal -->
<div class="modal" id="modM">
  <div style="flex:1" onclick="closeMode()"></div>
  <div class="sheet">
    <div class="sht">SELECT MODE</div>
    <div class="ssb">Choose team format</div>
    <div class="mgrid" id="mgrid"></div>
    <button class="btn-go" onclick="startSearch()">‚öî FIND MATCH</button>
    <button class="btn-cl" onclick="closeMode()">‚úï CANCEL</button>
  </div>
</div>

<!-- Waiting -->
<div class="wait" id="waitOvl">
  <div class="wspn"></div>
  <div class="wtxt">FINDING PLAYERS</div>
  <div class="wbox">
    <div class="wct"><span id="wh">1</span> / <span id="wn">2</span></div>
    <div class="wof">PLAYERS JOINED</div>
  </div>
  <div style="color:#666;font-size:11px" id="wsub">Searching...</div>
  <button class="btn-cl" style="width:180px;margin-top:6px" onclick="cancelSearch()">‚úï CANCEL</button>
</div>

<!-- Store Modal -->
<div class="modal" id="storeM">
  <div style="flex:1" onclick="closeStore()"></div>
  <div class="sheet" style="max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
    <div class="sht">GUN STORE</div>
    <div class="ssb" id="ssub">Equipped: 0/3 guns</div>
    <div class="frow" id="frow"></div>    <div class="slist" id="slist"></div>
    <button class="btn-cl" onclick="closeStore()" style="margin-top:8px;flex-shrink:0">‚úï CLOSE</button>
  </div>
</div>

<script>
let PD=null, selMode=null, eqGuns=[], hsOn=true;
let srchCh=null, srchInt=null, roomId=null, sfilt='All';

// ===== INIT =====
window.addEventListener('load', async () => {
  try{
    const {data:{session}} = await supabase.auth.getSession();
    if(!session){window.location.href='index.html';return}
    
    localStorage.setItem('rb_uid', session.user.id);
    const {data,error} = await supabase.from('players').select('*').eq('id',session.user.id).single();
    
    if(error || !data){
      console.error('Player load error:',error);
      window.location.href='index.html';
      return;
    }
    
    PD = data;
    localStorage.setItem('rb_un', data.username);
    eqGuns = data.selected_guns || ['desert','m1887','ump'];
    hsOn = data.headshot_on !== false;
    
    renderP();
    buildModes();
    updHS();
  }catch(e){
    console.error('Init error:',e);
    window.location.href='index.html';
  }
});

function renderP(){
  if(!PD)return;
  document.getElementById('pn').textContent = PD.username.toUpperCase();
  document.getElementById('ava').textContent = PD.username[0]?.toUpperCase()||'?';
  document.getElementById('pl').textContent = 'Level '+(PD.level||1);
  document.getElementById('sm').textContent = PD.total_matches||0;
  document.getElementById('sw2').textContent = PD.wins||0;
  document.getElementById('sk').textContent = PD.kills||0;
  document.getElementById('cd').textContent = PD.coins||0;
}

// ===== HEADSHOT TOGGLE =====function toggleHS(){
  tap();vib(30);
  hsOn = !hsOn;
  updHS();
  supabase.from('players').update({headshot_on:hsOn}).eq('id',PD?.id).then(({error})=>{
    if(error)console.error('HS update error:',error);
  });
}
function updHS(){
  const t=document.getElementById('hstgl');
  t.classList.toggle('on',hsOn);
  document.getElementById('hsp').textContent = hsOn
    ? 'ON ‚Äî Aim head for 2x damage'
    : 'OFF ‚Äî Body shots only';
}

// ===== MODES =====
function buildModes(){
  const g=document.getElementById('mgrid');
  if(!g)return;
  g.innerHTML='';
  MODES.forEach(m=>{
    const d=document.createElement('div');
    d.className='mb'+(selMode?.id===m.id?' sel':'');
    d.innerHTML=`<div class="mb-lbl">${m.label}</div><div class="mb-sub">${m.total} players</div>`;
    d.onclick=()=>{tap();vib(20);selMode=m;buildModes()};
    g.appendChild(d);
  });
}
function openMode(){tap();vib(25);buildModes();document.getElementById('modM').classList.add('show')}
function closeMode(){tap();document.getElementById('modM').classList.remove('show')}

// ===== MATCHMAKING =====
async function startSearch(){
  if(!selMode || !PD){alert('Please wait for load...');return}
  tap();vib([50,30,50]);
  closeMode();
  
  roomId = 'rb_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
  
  try{
    // Try to join existing room
    const{data:rooms}=await supabase.from('rooms')
      .select('*')
      .eq('mode',selMode.id)
      .eq('status','waiting')
      .lt('player_count',selMode.total)
      .order('created_at',{ascending:true})
      .limit(1);
        if(rooms?.[0]){
      roomId = rooms[0].room_id;
      await supabase.from('rooms')
        .update({player_count:rooms[0].player_count+1})
        .eq('room_id',roomId);
    }else{
      await supabase.from('rooms').insert({
        room_id:roomId, mode:selMode.id,
        total_needed:selMode.total, player_count:1, status:'waiting'
      });
    }
    
    // Determine team
    const{data:rps}=await supabase.from('room_players')
      .select('team').eq('room_id',roomId);
    const t1c=(rps||[]).filter(p=>p.team===1).length;
    const myTeam = t1c < selMode.t1 ? 1 : 2;
    
    // Join room
    await supabase.from('room_players').insert({
      room_id:roomId, player_id:PD.id, username:PD.username,
      team:myTeam, equipped_guns:eqGuns, hp:500, alive:true
    });
    
    // Show waiting UI
    document.getElementById('wn').textContent = selMode.total;
    document.getElementById('wh').textContent = (rps?.length||0)+1;
    document.getElementById('waitOvl').classList.add('show');
    
    // Realtime listener
    srchCh = supabase.channel('room_'+roomId)
      .on('postgres_changes',{
        event:'UPDATE',schema:'public',table:'rooms',
        filter:`room_id=eq.${roomId}`
      },async payload=>{
        const r = payload.new;
        document.getElementById('wh').textContent = r.player_count;
        if(r.player_count >= r.total_needed){
          clearInterval(srchInt);
          supabase.removeChannel(srchCh);
          await supabase.from('rooms').update({status:'active'}).eq('room_id',roomId);
          vib([100,50,100]);
          goGame(myTeam);
        }
      }).subscribe();
    
    // Fallback poll
    srchInt = setInterval(async()=>{
      try{
        const{data:r}=await supabase.from('rooms')          .select('player_count').eq('room_id',roomId).maybeSingle();
        if(r)document.getElementById('wh').textContent = r.player_count;
        const dots='.'.repeat((Date.now()/600|0)%4);
        document.getElementById('wsub').textContent='Searching'+dots;
      }catch(e){}
    },1200);
    
  }catch(err){
    console.error('Search error:',err);
    alert('Matchmaking error. Try again.');
    cancelSearch();
  }
}

async function cancelSearch(){
  tap();
  clearInterval(srchInt);
  if(srchCh)supabase.removeChannel(srchCh);
  if(roomId && PD?.id){
    await supabase.from('room_players')
      .delete().eq('room_id',roomId).eq('player_id',PD.id);
    try{
      const{data:r}=await supabase.from('rooms')
        .select('player_count').eq('room_id',roomId).maybeSingle();
      if(r){
        if(r.player_count<=1)
          await supabase.from('rooms').delete().eq('room_id',roomId);
        else
          await supabase.from('rooms')
            .update({player_count:r.player_count-1}).eq('room_id',roomId);
      }
    }catch(e){}
  }
  document.getElementById('waitOvl').classList.remove('show');
}

function goGame(team){
  localStorage.setItem('rb_room',roomId);
  localStorage.setItem('rb_mode',JSON.stringify(selMode));
  localStorage.setItem('rb_team',team);
  localStorage.setItem('rb_hs',hsOn?'1':'0');
  localStorage.setItem('rb_guns',JSON.stringify(eqGuns));
  window.location.href='game.html';
}

// ===== STORE =====
function openStore(){
  tap();vib(25);
  buildStore('All');
  document.getElementById('storeM').classList.add('show');}
function closeStore(){
  tap();
  document.getElementById('storeM').classList.remove('show');
  if(PD?.id){
    supabase.from('players').update({selected_guns:eqGuns}).eq('id',PD.id).catch(console.error);
  }
}

function buildStore(filt){
  sfilt=filt;
  const types=['All','Pistol','Shotgun','AR','SMG','Sniper','Special'];
  const fr=document.getElementById('frow');
  if(fr){
    fr.innerHTML='';
    types.forEach(t=>{
      const b=document.createElement('button');
      b.className='fb'+(t===filt?' on':'');
      b.textContent=t;
      b.onclick=()=>{tap();buildStore(t)};
      fr.appendChild(b);
    });
  }
  document.getElementById('ssub').textContent=`Equipped: ${eqGuns.length}/3 guns`;
  
  const sl=document.getElementById('slist');
  if(!sl)return;
  sl.innerHTML='';
  
  GUN_LIST.forEach(gid=>{
    const g=GUNS[gid];
    if(!g)return;
    if(filt!=='All' && g.type!==filt)return;
    
    const isEq=eqGuns.includes(gid);
    const d=document.createElement('div');
    d.className='si'+(isEq?' eq':'');
    d.innerHTML=`
      <span class="si-ic">üî´</span>
      <div class="si-info">
        <div class="si-n">${g.name}</div>
        <div class="si-t">${g.type}</div>
        <div class="si-st">DMG:${g.dmg} ‚Ä¢ RNG:${g.range}m ‚Ä¢ ${g.reload}s reload</div>
      </div>
      <button class="eq-btn ${isEq?'rem':'add'}" onclick="toggleEq('${gid}',event)">
        ${isEq?'‚úì ON':'EQUIP'}
      </button>`;
    sl.appendChild(d);
  });
}
function toggleEq(gid,e){
  e?.stopPropagation();
  tap();vib(25);
  if(eqGuns.includes(gid)){
    if(eqGuns.length<=1){alert('Keep at least 1 gun!');return}
    eqGuns=eqGuns.filter(x=>x!==gid);
  }else{
    if(eqGuns.length>=3)eqGuns.shift();
    eqGuns.push(gid);
  }
  buildStore(sfilt);
}

// ===== LOGOUT =====
async function doLogout(){
  tap();vib(20);
  if(!confirm('Logout?'))return;
  try{
    await supabase.auth.signOut();
  }catch(e){}
  localStorage.clear();
  window.location.href='index.html';
}
</script>
</body>
</html>

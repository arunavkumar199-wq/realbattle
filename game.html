<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>RealBattle ‚Äî FIGHT</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none;}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:'Rajdhani',sans-serif;}

/* CAMERA */
#cam{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;}

/* SCOPE */
.scope{position:absolute;inset:0;z-index:2;pointer-events:none;display:none;
  background:radial-gradient(ellipse 38% 52% at 50% 50%,transparent,rgba(0,0,0,.78) 100%);}
.scope-ring{position:absolute;top:50%;left:50%;width:200px;height:200px;
  margin:-100px 0 0 -100px;border:2px solid rgba(255,255,255,.4);border-radius:50%;}
.scope-v{position:absolute;top:50%;left:50%;}
.scope-v::before{content:'';position:absolute;width:200px;height:1px;
  top:-0.5px;left:-100px;background:rgba(255,255,255,.35);}
.scope-v::after{content:'';position:absolute;width:1px;height:200px;
  left:-0.5px;top:-100px;background:rgba(255,255,255,.35);}
#scopeEl.on{display:block;}

/* OVERLAYS */
.scanl{position:absolute;inset:0;z-index:1;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.025) 3px,rgba(0,0,0,.025) 4px);}
.vignette{position:absolute;inset:0;z-index:1;pointer-events:none;
  background:radial-gradient(ellipse 80% 80% at 50% 50%,transparent 40%,rgba(0,0,0,.45));}
#hitFlash{position:absolute;inset:0;z-index:5;pointer-events:none;
  background:rgba(255,0,0,0);transition:background .05s;}
#hitFlash.pop{background:rgba(255,0,0,.38);}
#shootFlash{position:absolute;inset:0;z-index:4;pointer-events:none;
  background:rgba(255,200,50,0);transition:background .04s;}
#shootFlash.pop{background:rgba(255,200,50,.1);}

/* TOP HUD */
.thud{position:absolute;top:0;left:0;right:0;z-index:10;padding:44px 12px 0;}
.hp-row{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.62);
  backdrop-filter:blur(8px);border-radius:12px;padding:8px 12px;
  border:1px solid rgba(255,255,255,.07);margin-bottom:6px;}
.hp-av{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:14px;font-weight:900;color:#fff;flex-shrink:0;}
.hp-av.en{background:linear-gradient(135deg,#aa0000,#ff3333);}
.hp-av.me{background:linear-gradient(135deg,#FF6B00,#ff4500);}
.hp-sec{flex:1;}
.hp-name{font-size:10px;font-weight:700;color:#aaa;letter-spacing:1px;margin-bottom:3px;}
.hp-bar{height:7px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;}
.hp-fill{height:100%;border-radius:4px;transition:width .35s ease;}
.hfe{background:linear-gradient(90deg,#aa0000,#ff4444);}
.hfm{background:linear-gradient(90deg,#00aa33,#00ff66);}
.hfm.w{background:linear-gradient(90deg,#ff6600,#ffaa00);}
.hfm.c{background:linear-gradient(90deg,#aa0000,#ff3333);}
.hp-n{font-size:14px;font-weight:700;flex-shrink:0;}
.hp-n.en{color:#ff4444;}
.hp-n.me{color:#00ff66;}
.timer-row{text-align:center;margin-bottom:6px;}
.timer{display:inline-block;background:rgba(0,0,0,.65);border-radius:10px;
  padding:4px 20px;font-family:'Bebas Neue',sans-serif;font-size:22px;
  letter-spacing:3px;color:#fff;border:1px solid rgba(255,255,255,.07);}
.timer.d{color:#ff3333;animation:blnk .4s infinite;}
@keyframes blnk{0%,100%{opacity:1;}50%{opacity:.25;}}
.team-row{display:flex;gap:5px;background:rgba(0,0,0,.55);
  border-radius:10px;padding:5px 10px;border:1px solid rgba(255,255,255,.05);
  overflow-x:auto;margin-bottom:2px;}
.tm{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.tmd{width:7px;height:7px;border-radius:50%;}
.tmd.a{background:#00ff66;}
.tmd.d{background:#333;}
.tmn{font-size:10px;font-weight:700;}
.tmh{font-size:10px;color:#00ff66;}

/* ENEMY MARKERS */
.emarkers{position:absolute;inset:0;z-index:8;pointer-events:none;}
.em{position:absolute;transform:translate(-50%,-100%);
  display:flex;flex-direction:column;align-items:center;gap:1px;}
.em-dot{width:13px;height:13px;border-radius:50%;
  border:2px solid #ff3333;background:rgba(255,30,30,.3);
  animation:emp 1s ease-in-out infinite;
  box-shadow:0 0 10px #ff3333,0 0 20px rgba(255,0,0,.3);}
.em-dot.ally{border-color:#00ff66;background:rgba(0,255,100,.2);box-shadow:0 0 10px #00ff66;}
@keyframes emp{0%,100%{transform:scale(1);}50%{transform:scale(1.35);}}
.em-tag{background:rgba(0,0,0,.75);border:1px solid rgba(255,30,30,.5);
  border-radius:6px;padding:2px 6px;font-size:10px;font-weight:700;
  color:#ff4444;white-space:nowrap;}
.em-tag.ally{border-color:rgba(0,255,100,.5);color:#00ff66;}
.em-hp{font-size:10px;color:#ff4444;font-weight:700;}
.em-hp.ally{color:#00ff66;}
.em-dist{font-size:9px;color:#888;}

/* AIM INDICATOR */
.aim-ind{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:60px;height:60px;border-radius:50%;border:2px solid #ff3333;
  z-index:9;pointer-events:none;opacity:0;transition:opacity .2s;
  box-shadow:0 0 20px #ff3333,inset 0 0 15px rgba(255,0,0,.1);}
.aim-ind.on{opacity:1;animation:aimp .3s ease;}
@keyframes aimp{0%{transform:translate(-50%,-50%) scale(1.6);}100%{transform:translate(-50%,-50%) scale(1);}}

/* CROSSHAIR */
.xhair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  z-index:9;pointer-events:none;}
.xh{width:58px;height:58px;position:relative;transition:transform .1s;}
.xh.spr{transform:scale(1.45);}
.xl{position:absolute;background:rgba(255,255,255,.88);}
.xl.t{top:0;left:50%;transform:translateX(-50%);width:2px;height:16px;}
.xl.b{bottom:0;left:50%;transform:translateX(-50%);width:2px;height:16px;}
.xl.l{left:0;top:50%;transform:translateY(-50%);height:2px;width:16px;}
.xl.r{right:0;top:50%;transform:translateY(-50%);height:2px;width:16px;}
.xl.dt{top:50%;left:50%;transform:translate(-50%,-50%);width:4px;height:4px;border-radius:50%;background:#ff3333;}
.xh-ring{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:58px;height:58px;border:1.5px solid rgba(255,255,255,.25);border-radius:50%;}
.xh.aimed .xl.dt{box-shadow:0 0 8px #ff3333;}

/* KILL FEED */
.kfeed{position:absolute;top:220px;right:12px;z-index:10;
  display:flex;flex-direction:column;gap:3px;pointer-events:none;max-width:190px;}
.kf{background:rgba(0,0,0,.75);border-radius:8px;padding:4px 9px;
  font-size:11px;font-weight:700;animation:kfi 3s ease forwards;
  border:1px solid rgba(255,30,30,.2);}
.kf.ok{color:#00ff66;border-color:rgba(0,255,100,.2);}
.kf.bad{color:#ff4444;}
@keyframes kfi{0%{opacity:0;transform:translateX(18px);}15%{opacity:1;transform:translateX(0);}80%{opacity:1;}100%{opacity:0;}}

/* DAMAGE NUMBER */
.dnum{position:absolute;z-index:11;pointer-events:none;
  font-family:'Bebas Neue',sans-serif;
  text-shadow:0 2px 10px rgba(0,0,0,.9),0 0 18px rgba(255,200,0,.6);
  animation:dnf 1.1s ease-out forwards;}
.dnum.n{color:#FFD700;font-size:34px;}
.dnum.h{color:#ff3333;font-size:44px;}
@keyframes dnf{0%{opacity:1;transform:translateY(0) scale(1.2);}100%{opacity:0;transform:translateY(-85px) scale(.5);}}

/* BULLET TRAIL */
.btrail{position:absolute;z-index:7;pointer-events:none;
  height:2px;transform-origin:left center;
  animation:bta .15s ease-out forwards;}
@keyframes bta{0%{opacity:.9;}100%{opacity:0;}}

/* BOTTOM HUD */
.bhud{position:absolute;bottom:0;left:0;right:0;z-index:10;padding:0 10px 22px;}

/* GUN SLOTS (top right) */
.gslots{display:flex;justify-content:flex-end;gap:6px;margin-bottom:8px;}
.gs{background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.1);
  border-radius:10px;padding:6px 10px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:6px;}
.gs:active{transform:scale(.92);}
.gs.on{border-color:#FF6B00;background:rgba(255,107,0,.22);}
.gs-n{font-size:10px;font-weight:700;color:#FF6B00;min-width:20px;text-align:center;}
.gs-nm{font-size:11px;font-weight:700;color:#fff;max-width:64px;
  overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.gs-t{font-size:9px;color:#555;}

/* CTRL ROW */
.ctrl{display:flex;align-items:flex-end;justify-content:space-between;}

/* LEFT */
.lctrl{display:flex;flex-direction:column;gap:8px;}
.cb{width:62px;height:62px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:22px;cursor:pointer;transition:all .15s;
  backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.1);}
.cb:active{transform:scale(.88);}
.cb-scope{background:rgba(0,80,200,.38);border-color:rgba(0,100,255,.5);}
.cb-scope.on{background:rgba(0,80,200,.75);border-color:#0088ff;}
.cb-sw{background:rgba(255,107,0,.32);border-color:rgba(255,107,0,.5);}
.cb-mic{background:rgba(0,0,0,.55);border-color:rgba(255,255,255,.12);}
.cb-mic.spk{background:rgba(0,180,0,.25);border-color:#00cc00;
  box-shadow:0 0 14px rgba(0,255,0,.35);}

/* RELOAD BAR */
.rlbar{position:absolute;bottom:178px;right:135px;z-index:10;text-align:right;display:none;}
.rl-t{font-size:10px;font-weight:700;color:#FF6B00;letter-spacing:2px;margin-bottom:3px;}
.rl-b{width:105px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden;}
.rl-f{height:100%;background:#FF6B00;border-radius:3px;width:0%;}

/* AMMO */
.ammo{position:absolute;bottom:145px;right:128px;z-index:10;text-align:right;}
.am-c{font-family:'Bebas Neue',sans-serif;font-size:38px;color:#fff;line-height:1;}
.am-l{font-size:10px;color:#FF6B00;letter-spacing:2px;}
.am-inf{font-size:11px;color:#444;letter-spacing:1px;}

/* FIRE BUTTON */
.fwrap{display:flex;flex-direction:column;align-items:center;gap:7px;}
.chbar{width:115px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden;display:none;}
.chfill{height:100%;background:linear-gradient(90deg,#aa00ff,#ff00ff);width:0%;}
.chbar.show{display:block;}
.fbtn{width:115px;height:115px;border-radius:50%;
  background:radial-gradient(circle at 35% 35%,#ff4444,#bb0000);
  border:3px solid rgba(255,100,100,.5);
  display:flex;align-items:center;justify-content:center;
  font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:#fff;
  cursor:pointer;
  box-shadow:0 8px 30px rgba(255,0,0,.5),0 0 0 8px rgba(255,0,0,.1);
  transition:all .08s;}
.fbtn:active,.fbtn.pr{transform:scale(.88);
  box-shadow:0 4px 15px rgba(255,0,0,.35);
  background:radial-gradient(circle at 35% 35%,#ff6666,#ff2222);}

/* HUD RESIZE */
.hudctrl{position:absolute;top:50%;left:8px;transform:translateY(-50%);z-index:10;
  display:flex;flex-direction:column;gap:5px;}
.hc{width:34px;height:34px;border-radius:8px;background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;
  justify-content:center;font-size:15px;cursor:pointer;}
.hc:active{background:rgba(255,107,0,.3);}

/* CHAT */
.chatbox{position:absolute;bottom:190px;left:10px;z-index:10;
  max-width:175px;display:flex;flex-direction:column;gap:3px;pointer-events:none;}
.cm{background:rgba(0,0,0,.72);border-radius:8px;padding:4px 8px;
  font-size:11px;color:#fff;animation:cmf 5s ease forwards;
  border:1px solid rgba(255,255,255,.05);}
.cm-n{color:#FF6B00;font-weight:700;}
@keyframes cmf{0%{opacity:0;}10%{opacity:1;}80%{opacity:1;}100%{opacity:0;}}

/* START OVERLAY */
.sovl{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.9);
  backdrop-filter:blur(12px);display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:18px;}
.sovl.h{display:none;}
.vsr{display:flex;align-items:center;gap:20px;flex-wrap:wrap;justify-content:center;}
.vp{text-align:center;}
.vav{width:68px;height:68px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:28px;font-weight:900;color:#fff;margin:0 auto 6px;}
.vav.m{background:linear-gradient(135deg,#FF6B00,#ff4500);}
.vav.e{background:linear-gradient(135deg,#aa0000,#ff3333);}
.vnm{font-size:13px;font-weight:700;letter-spacing:1px;}
.vdiv{font-family:'Bebas Neue',sans-serif;font-size:34px;color:#FF6B00;}
.vtxt{font-family:'Bebas Neue',sans-serif;font-size:50px;letter-spacing:6px;
  color:#FF6B00;text-shadow:0 0 40px rgba(255,107,0,.8);}
.cdn{font-family:'Bebas Neue',sans-serif;font-size:110px;color:#fff;
  text-shadow:0 0 60px rgba(255,107,0,.9);animation:cdp 1s ease-out;}
@keyframes cdp{0%{transform:scale(2);opacity:0;}100%{transform:scale(1);opacity:1;}}
.mbdg2{font-size:12px;color:#555;letter-spacing:3px;background:rgba(255,255,255,.05);
  border-radius:8px;padding:6px 18px;border:1px solid rgba(255,255,255,.07);}

/* GAME OVER */
.goscreen{display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.93);backdrop-filter:blur(16px);
  flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.goscreen.show{display:flex;}
.go-ic{font-size:90px;animation:bce .5s ease;}
@keyframes bce{0%{transform:scale(0);}60%{transform:scale(1.2);}100%{transform:scale(1);}}
.go-t{font-family:'Bebas Neue',sans-serif;font-size:62px;letter-spacing:6px;}
.go-t.w{color:#00ff66;text-shadow:0 0 50px rgba(0,255,100,.7);}
.go-t.l{color:#ff3333;text-shadow:0 0 50px rgba(255,0,0,.7);}
.go-stats{background:#0f0f1c;border:1px solid rgba(255,255,255,.07);
  border-radius:16px;padding:20px 32px;
  display:grid;grid-template-columns:repeat(2,1fr);gap:14px;
  text-align:center;min-width:270px;}
.gs2 label{display:block;font-size:10px;color:#555;letter-spacing:2px;}
.gs2 span{display:block;font-size:22px;font-weight:700;color:#fff;margin-top:2px;}
.btn-lb{padding:16px 48px;background:linear-gradient(135deg,#FF6B00,#FF4500);
  border:none;border-radius:13px;color:#fff;font-family:'Rajdhani',sans-serif;
  font-size:17px;font-weight:700;letter-spacing:3px;cursor:pointer;
  box-shadow:0 6px 25px rgba(255,107,0,.4);}
.btn-lb:active{transform:scale(.97);}

/* PERM SCREEN */
.pscr{position:fixed;inset:0;z-index:999;background:#07070f;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:18px;padding:28px;text-align:center;}
.pscr.h{display:none;}
.p-t{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:4px;color:#FF6B00;}
.p-s{font-size:14px;color:#666;line-height:1.6;max-width:300px;}
.plist{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px;}
.pi{display:flex;align-items:center;gap:12px;background:#111122;
  border-radius:12px;padding:13px;border:1px solid rgba(255,255,255,.05);font-size:14px;font-weight:600;}
.pi-ic{font-size:22px;}
.pi-ok{width:15px;height:15px;border-radius:50%;border:2px solid #333;flex-shrink:0;margin-left:auto;}
.pi-ok.d{background:#00ff66;border-color:#00ff66;}
.btnp{width:100%;max-width:300px;padding:17px;
  background:linear-gradient(135deg,#FF6B00,#FF4500);border:none;border-radius:13px;
  color:#fff;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;
  letter-spacing:3px;cursor:pointer;}
.btnp:active{transform:scale(.97);}
</style>
</head>
<body>

<!-- PERMISSION SCREEN -->
<div class="pscr" id="pscr">
  <div class="p-t">‚öî REALBATTLE</div>
  <div class="p-s">Game ke liye yeh permissions allow karo. Bina inke game nahi chalega.</div>
  <div class="plist">
    <div class="pi"><span class="pi-ic">üì∑</span>Camera (AR view)<div class="pi-ok" id="pkc"></div></div>
    <div class="pi"><span class="pi-ic">üìç</span>Location (distance detection)<div class="pi-ok" id="pkg"></div></div>
    <div class="pi"><span class="pi-ic">üß≠</span>Motion & Compass (aiming)<div class="pi-ok" id="pkm"></div></div>
    <div class="pi"><span class="pi-ic">üé§</span>Microphone (voice chat)<div class="pi-ok" id="pka"></div></div>
  </div>
  <button class="btnp" onclick="reqPerms()">‚úÖ ALLOW ALL & START GAME</button>
</div>

<!-- CAMERA + OVERLAYS -->
<video id="cam" autoplay playsinline muted></video>
<div class="scope" id="scopeEl"><div class="scope-ring"></div><div class="scope-v"></div></div>
<div class="scanl"></div>
<div class="vignette"></div>
<div id="hitFlash"></div>
<div id="shootFlash"></div>

<!-- TOP HUD -->
<div class="thud" id="thud">
  <div id="eHProws"></div>
  <div class="timer-row"><div class="timer" id="gTimer">3:00</div></div>
  <div class="hp-row">
    <div class="hp-av me" id="myAv">?</div>
    <div class="hp-sec">
      <div class="hp-name" id="myNm">YOU</div>
      <div class="hp-bar"><div class="hp-fill hfm" id="myBar" style="width:100%"></div></div>
    </div>
    <div class="hp-n me" id="myHpN">500</div>
  </div>
  <div class="team-row" id="tmrow"></div>
</div>

<!-- AIM INDICATOR -->
<div class="aim-ind" id="aimInd"></div>

<!-- ENEMY AR MARKERS -->
<div class="emarkers" id="emkrs"></div>

<!-- CROSSHAIR -->
<div class="xhair"><div class="xh" id="xh">
  <div class="xh-ring"></div>
  <div class="xl t"></div><div class="xl b"></div>
  <div class="xl l"></div><div class="xl r"></div>
  <div class="xl dt"></div>
</div></div>

<!-- KILL FEED -->
<div class="kfeed" id="kfeed"></div>

<!-- HUD CONTROLS -->
<div class="hudctrl">
  <div class="hc" onclick="adjHUD(1)" title="Bada karo">‚ûï</div>
  <div class="hc" onclick="adjHUD(-1)" title="Chota karo">‚ûñ</div>
  <div class="hc" onclick="adjHUD(0)" title="Transparent">üëÅ</div>
</div>

<!-- CHAT -->
<div class="chatbox" id="chatbox"></div>

<!-- AMMO -->
<div class="ammo">
  <div class="am-c">‚àû</div>
  <div class="am-l">AMMO</div>
  <div class="am-inf">UNLIMITED</div>
</div>

<!-- RELOAD BAR -->
<div class="rlbar" id="rlbar">
  <div class="rl-t">RELOADING</div>
  <div class="rl-b"><div class="rl-f" id="rlf"></div></div>
</div>

<!-- BOTTOM HUD -->
<div class="bhud" id="bhud">
  <div class="gslots" id="gslots"></div>
  <div class="ctrl">
    <div class="lctrl">
      <div class="cb cb-scope" id="scopeBtn" onclick="togScope()">üî≠</div>
      <div class="cb cb-sw" onclick="nxtGun()">üîÑ</div>
      <div class="cb cb-mic" id="micBtn" onclick="togMic()">üîá</div>
    </div>
    <div class="fwrap">
      <div class="chbar" id="chbar"><div class="chfill" id="chfill"></div></div>
      <div class="fbtn" id="fbtn"
        ontouchstart="fdown(event)" ontouchend="fup(event)"
        onmousedown="fdown(event)" onmouseup="fup(event)">FIRE</div>
    </div>
  </div>
</div>

<!-- START COUNTDOWN -->
<div class="sovl" id="sovl">
  <div class="mbdg2" id="mBdg">1 v 1 ¬∑ AR BATTLE</div>
  <div class="vsr" id="vsrow">Loading...</div>
  <div class="vtxt">BATTLE!</div>
  <div class="cdn" id="cdn">3</div>
</div>

<!-- GAME OVER -->
<div class="goscreen" id="goscreen">
  <div class="go-ic" id="goIc">üèÜ</div>
  <div class="go-t" id="goT">VICTORY</div>
  <div class="go-stats">
    <div class="gs2"><label>DAMAGE</label><span id="gDmg">0</span></div>
    <div class="gs2"><label>KILLS</label><span id="gKill">0</span></div>
    <div class="gs2"><label>HEADSHOTS</label><span id="gHS">0</span></div>
    <div class="gs2"><label>COINS +</label><span id="gCoin">0</span></div>
  </div>
  <button class="btn-lb" onclick="goLobby()">‚¨Ö LOBBY</button>
</div>

<script>
// =============================================
// VARS
// =============================================
const roomId    = localStorage.getItem('rb_room');
const myUid     = localStorage.getItem('rb_uid');
const myUN      = localStorage.getItem('rb_un');
const myTeam    = parseInt(localStorage.getItem('rb_team')||'1');
const modeData  = JSON.parse(localStorage.getItem('rb_mode')||'{"id":"1v1","label":"1v1","t1":1,"t2":1,"total":2}');
const hsMode    = localStorage.getItem('rb_hs')==='1';
const myGunIds  = JSON.parse(localStorage.getItem('rb_guns')||'["desert","m1887","ump"]');

let myHP=500, gone=false, started=false;
let gunIdx=0, reloading=false, canFire=true;
let scopeOn=false, micOn=false;
let charging=false, chargeT=0;
let hudScale=1, hudAlpha=1;
let dmgTotal=0, kills=0, hsCount=0;
let myLat=0, myLon=0, myHd=0, myPitch=0;
let gpsOk=false, compassOk=false;
let players={};  // uid -> {username,team,lat,lon,hp,alive,heading,pitch}
let enemies=[];
let gameCh=null, posInt=null, timerInt=null;
let timeLeft=180;
let localStream=null;
let autoFInt=null;
let peerConns={};

// =============================================
// PERMISSIONS
// =============================================
async function reqPerms(){
  tap();vib(30);

  // Camera
  try{
    const s=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'},width:{ideal:1280}},audio:false});
    document.getElementById('cam').srcObject=s;
    document.getElementById('pkc').classList.add('d');
  }catch(e){console.warn('cam:',e);}

  // GPS
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      myLat=p.coords.latitude;myLon=p.coords.longitude;gpsOk=true;
      document.getElementById('pkg').classList.add('d');
    },()=>{gpsOk=false;document.getElementById('pkg').classList.add('d');});
  }

  // Compass
  try{
    if(typeof DeviceOrientationEvent!=='undefined'&&
       typeof DeviceOrientationEvent.requestPermission==='function'){
      const r=await DeviceOrientationEvent.requestPermission();
      if(r==='granted') setupCompass();
    } else { setupCompass(); }
    document.getElementById('pkm').classList.add('d');
  }catch(e){setupCompass();}

  // Mic
  try{
    localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
    localStream.getAudioTracks().forEach(t=>t.enabled=false);
    document.getElementById('pka').classList.add('d');
  }catch(e){console.warn('mic:',e);}

  setTimeout(()=>initGame(),700);
}

function setupCompass(){
  window.addEventListener('deviceorientation',e=>{
    const h=e.webkitCompassHeading||e.alpha;
    if(h!=null) myHd=h;
    if(e.beta!=null) myPitch=e.beta;
    compassOk=true;
  },true);
}

// =============================================
// INIT GAME
// =============================================
async function initGame(){
  document.getElementById('pscr').classList.add('h');
  if(!roomId||!myUid){window.location.href='home.html';return;}

  // Load players
  const{data:rps}=await supabase.from('room_players').select('*').eq('room_id',roomId);
  if(!rps||rps.length===0){window.location.href='home.html';return;}

  rps.forEach(p=>{
    players[p.player_id]={
      username:p.username,team:p.team,
      lat:p.lat||0,lon:p.lon||0,hp:500,alive:true,
      heading:p.heading||0,pitch:p.pitch||0,
      guns:p.equipped_guns||['desert']
    };
  });
  enemies=rps.filter(p=>p.player_id!==myUid&&p.team!==myTeam).map(p=>p.player_id);

  // UI
  document.getElementById('myAv').textContent=myUN[0].toUpperCase();
  document.getElementById('myNm').textContent=myUN.toUpperCase();
  document.getElementById('mBdg').textContent=modeData.label+' ¬∑ AR BATTLE';

  buildVS(rps); buildTeamRow(rps); buildEnemyHP(rps); buildGunSlots();

  setupChannel();

  // GPS watch
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(p=>{
      myLat=p.coords.latitude;myLon=p.coords.longitude;gpsOk=true;
    },{enableHighAccuracy:true,maximumAge:500,timeout:8000});
  }

  posInt=setInterval(broadcastPos,500);
  setInterval(updateMarkers,200);
  startCD();
}

// =============================================
// BUILD UI
// =============================================
function buildVS(rps){
  const t1=rps.filter(p=>p.team===myTeam);
  const t2=rps.filter(p=>p.team!==myTeam);
  let h='<div style="display:flex;gap:6px;justify-content:center">';
  t1.forEach(p=>{h+=`<div class="vp"><div class="vav m">${p.username[0].toUpperCase()}</div><div class="vnm">${p.username.slice(0,8).toUpperCase()}</div></div>`;});
  h+='</div><div class="vdiv">VS</div><div style="display:flex;gap:6px;justify-content:center">';
  t2.forEach(p=>{h+=`<div class="vp"><div class="vav e">${p.username[0].toUpperCase()}</div><div class="vnm">${p.username.slice(0,8).toUpperCase()}</div></div>`;});
  h+='</div>';
  document.getElementById('vsrow').innerHTML=h;
}

function buildTeamRow(rps){
  const r=document.getElementById('tmrow');r.innerHTML='';
  rps.filter(p=>p.player_id!==myUid&&p.team===myTeam).forEach(p=>{
    const d=document.createElement('div');d.className='tm';d.id='tmw_'+p.player_id;
    d.innerHTML=`<div class="tmd a" id="tmd_${p.player_id}"></div>
      <span class="tmn">${p.username.slice(0,7).toUpperCase()}</span>
      <span class="tmh" id="tmh_${p.player_id}">500</span>`;
    r.appendChild(d);
  });
}

function buildEnemyHP(rps){
  const c=document.getElementById('eHProws');c.innerHTML='';
  rps.filter(p=>p.team!==myTeam).forEach(p=>{
    const d=document.createElement('div');d.className='hp-row';d.id='ehp_'+p.player_id;
    d.innerHTML=`
      <div class="hp-av en">${p.username[0].toUpperCase()}</div>
      <div class="hp-sec">
        <div class="hp-name">${p.username.toUpperCase()}</div>
        <div class="hp-bar"><div class="hp-fill hfe" id="ehpb_${p.player_id}" style="width:100%"></div></div>
      </div>
      <div class="hp-n en" id="ehpn_${p.player_id}">500</div>`;
    c.appendChild(d);
  });
}

function buildGunSlots(){
  const c=document.getElementById('gslots');c.innerHTML='';
  myGunIds.slice(0,3).forEach((gid,i)=>{
    const g=GUNS[gid];if(!g)return;
    const d=document.createElement('div');
    d.className='gs'+(i===0?' on':'');d.id='gsl_'+i;
    d.innerHTML=`<span class="gs-n">${i+1}</span><div><div class="gs-nm">${g.short}</div><div class="gs-t">${g.type}</div></div>`;
    d.onclick=()=>selGun(i);
    c.appendChild(d);
  });
}

// =============================================
// REALTIME CHANNEL
// =============================================
function setupChannel(){
  gameCh=supabase.channel('game_'+roomId,{config:{broadcast:{self:false}}})
    .on('broadcast',{event:'pos'},msg=>{
      const d=msg.payload;
      if(d.uid===myUid)return;
      if(players[d.uid]){
        players[d.uid].lat=d.lat;players[d.uid].lon=d.lon;
        players[d.uid].heading=d.hd;players[d.uid].pitch=d.pt;
      }
    })
    .on('broadcast',{event:'hit'},msg=>{
      const d=msg.payload;
      if(d.tid===myUid&&!gone) takeDmg(d.dmg,d.isHead,d.by);
      if(d.tid!==myUid){
        const p=players[d.tid];
        if(p){p.hp=Math.max(0,p.hp-d.dmg);updEHP(d.tid,p.hp);}
      }
    })
    .on('broadcast',{event:'death'},msg=>{
      const d=msg.payload;
      if(d.uid===myUid)return;
      if(players[d.uid])players[d.uid].alive=false;
      addKF('üíÄ '+d.un+' eliminated!',d.killer===myUN);
      updTeamDot(d.uid); checkWin();
    })
    .on('broadcast',{event:'go'},msg=>{
      if(!gone) endGame(msg.payload.wt===myTeam?'win':'lose');
    })
    .on('broadcast',{event:'chat'},msg=>{
      addChat(msg.payload.un,msg.payload.txt);
    })
    .subscribe();
}

function broadcastPos(){
  if(!gameCh||!started)return;
  gameCh.send({type:'broadcast',event:'pos',payload:{
    uid:myUid,lat:myLat,lon:myLon,hd:myHd,pt:myPitch
  }});
}

// =============================================
// AR MARKERS
// =============================================
function updateMarkers(){
  const c=document.getElementById('emkrs');c.innerHTML='';
  if(!started)return;
  let anyAimed=false;
  const FOV=65;

  Object.entries(players).forEach(([uid,p])=>{
    if(uid===myUid||!p.alive)return;
    const isE=p.team!==myTeam;
    const dist=gpsOk&&p.lat?gpsDist(myLat,myLon,p.lat,p.lon):5;
    const bear=gpsOk&&p.lat?gpsBear(myLat,myLon,p.lat,p.lon):myHd;
    const diff=angDiff(myHd,bear);
    if(diff>FOV/2)return;

    // Direction (left or right of center)
    let hdDiff=bear-myHd; if(hdDiff>180)hdDiff-=360; if(hdDiff<-180)hdDiff+=360;
    const sx=50+(hdDiff/(FOV/2))*42;
    const sy=35;

    const m=document.createElement('div');
    m.className='em';m.style.left=sx+'%';m.style.top=sy+'%';
    m.innerHTML=`
      <div class="em-dot${isE?'':' ally'}"></div>
      <div class="em-tag${isE?'':' ally'}">${p.username.slice(0,8).toUpperCase()}</div>
      <div class="em-hp${isE?'':' ally'}">${p.hp}HP</div>
      <div class="em-dist">${dist<1?'<1m':Math.round(dist)+'m'}</div>`;
    c.appendChild(m);

    if(isE){
      const aimed=isAiming(myLat,myLon,myHd,p.lat,p.lon);
      if(aimed)anyAimed=true;
    }
  });

  document.getElementById('aimInd').classList.toggle('on',anyAimed);
  document.getElementById('xh').classList.toggle('aimed',anyAimed);
}

// =============================================
// GUN SELECTION
// =============================================
function selGun(i){
  if(reloading||gone)return;
  tap();vib(20);
  gunIdx=i;
  document.querySelectorAll('.gs').forEach((s,j)=>s.classList.toggle('on',j===i));
  document.getElementById('xh').classList.add('spr');
  setTimeout(()=>document.getElementById('xh').classList.remove('spr'),300);
}
function nxtGun(){
  if(reloading||gone)return;
  tap();vib(20);
  selGun((gunIdx+1)%Math.min(myGunIds.length,3));
}
function curGun(){return GUNS[myGunIds[gunIdx]]||GUNS['desert'];}

// =============================================
// FIRE
// =============================================
function fdown(e){
  e.preventDefault();
  if(gone||!started)return;
  const g=curGun();
  if(g.charge){
    charging=true;chargeT=Date.now();
    document.getElementById('chbar').classList.add('show');
    const cf=document.getElementById('chfill');
    cf.style.transition='none';cf.style.width='0%';
    setTimeout(()=>{cf.style.transition=`width ${g.reload}s linear`;cf.style.width='100%';},20);
    return;
  }
  if(g.type==='SMG'||g.type==='AR'||g.type==='Pistol'){
    doShoot(); autoFInt=setInterval(doShoot,g.rate*1000);
  } else { doShoot(); }
}

function fup(e){
  e.preventDefault();
  clearInterval(autoFInt);
  const g=curGun();
  if(g.charge&&charging){
    const held=Math.min((Date.now()-chargeT)/1000,g.reload);
    const pct=held/g.reload;
    charging=false;
    document.getElementById('chbar').classList.remove('show');
    document.getElementById('chfill').style.width='0%';
    doShoot(pct);
  }
}

function doShoot(chMult=1){
  if(reloading||gone||!started||!canFire)return;
  const g=curGun();
  canFire=false;
  shootSnd(g.type);
  vib(15);

  // Flash
  const sf=document.getElementById('shootFlash');
  sf.classList.add('pop');setTimeout(()=>sf.classList.remove('pop'),80);
  // Crosshair spread
  document.getElementById('xh').classList.add('spr');
  setTimeout(()=>document.getElementById('xh').classList.remove('spr'),150);
  // Bullet trail
  spawnBullet();

  // Hit each enemy we're aimed at
  Object.entries(players).forEach(([uid,p])=>{
    if(uid===myUid||p.team===myTeam||!p.alive)return;
    const dist=gpsOk&&p.lat?gpsDist(myLat,myLon,p.lat,p.lon):5;
    const aimed=isAiming(myLat,myLon,myHd,p.lat,p.lon);
    if(!aimed)return;
    const isHead=hsMode&&isHeadshot(myPitch,dist);
    let dmg=calcDmg(g,dist,isHead);
    if(g.charge)dmg=Math.round(dmg*(.4+chMult*.6));
    dmgTotal+=dmg; if(isHead)hsCount++;
    showDmgN(dmg,isHead);
    gameCh.send({type:'broadcast',event:'hit',payload:{
      tid:uid,dmg,isHead,by:myUN,from:myUid
    }});
    p.hp=Math.max(0,p.hp-dmg); updEHP(uid,p.hp);
    if(p.hp<=0&&p.alive){
      p.alive=false;kills++;
      gameCh.send({type:'broadcast',event:'death',payload:{
        uid,un:p.username,killer:myUN,kt:myTeam
      }});
      addKF('üí• You killed '+p.username+'!',true);
      vib([100,30,100]); checkWin();
    }
  });

  setTimeout(()=>{canFire=true;},g.rate*1000);
  // Auto reload trigger
  setTimeout(()=>{if(!reloading)doReload();},g.rate*1000*g.ammo+300);
}

function spawnBullet(){
  const g=curGun();
  const el=document.createElement('div');
  el.className='btrail';
  const cx=window.innerWidth/2, cy=window.innerHeight/2;
  const len=window.innerWidth*.45;
  const ang=((Math.random()-.5)*8)*Math.PI/180;
  el.style.cssText=`left:${cx}px;top:${cy}px;width:${len}px;
    background:${g.charge?'rgba(200,0,255,.7)':g.type==='Shotgun'?'rgba(255,160,50,.6)':'rgba(255,230,100,.55)'};
    transform-origin:left center;transform:rotate(${ang}rad);`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),200);
}

// =============================================
// TAKE DAMAGE
// =============================================
function takeDmg(dmg,isHead,by){
  if(gone)return;
  myHP=Math.max(0,myHP-dmg); updMyHP();
  const hf=document.getElementById('hitFlash');
  hf.classList.add('pop');setTimeout(()=>hf.classList.remove('pop'),160);
  vib([35,10,35]);
  addKF('üí¢ '+by+' hit you -'+dmg+(isHead?' ‚ö°HEAD':''),false);
  if(myHP<=0)myDied();
}

function myDied(){
  gone=true; clearInterval(timerInt);clearInterval(posInt);clearInterval(autoFInt);
  setTimeout(()=>endGame('lose'),800);
}

// =============================================
// HP DISPLAY
// =============================================
function updMyHP(){
  const pct=(myHP/500)*100;
  const b=document.getElementById('myBar');
  b.style.width=pct+'%';
  b.className='hp-fill hfm'+(myHP<150?' c':myHP<300?' w':'');
  document.getElementById('myHpN').textContent=myHP;
}

function updEHP(uid,hp){
  const b=document.getElementById('ehpb_'+uid);
  const n=document.getElementById('ehpn_'+uid);
  if(b)b.style.width=((hp/500)*100)+'%';
  if(n)n.textContent=hp;
  const th=document.getElementById('tmh_'+uid);
  if(th)th.textContent=hp;
}

function updTeamDot(uid){
  const d=document.getElementById('tmd_'+uid);
  if(d){d.classList.remove('a');d.classList.add('d');}
  const e=document.getElementById('ehp_'+uid);
  if(e)e.style.opacity='.35';
}

// =============================================
// RELOAD
// =============================================
function doReload(){
  if(reloading)return;
  const g=curGun();
  reloading=true;canFire=false;
  clearInterval(autoFInt);
  const rb=document.getElementById('rlbar');
  const rf=document.getElementById('rlf');
  rb.style.display='block';
  rf.style.transition='none';rf.style.width='0%';
  setTimeout(()=>{rf.style.transition=`width ${g.reload}s linear`;rf.style.width='100%';},30);
  vib([10,10,10]);
  setTimeout(()=>{
    reloading=false;canFire=true;
    rb.style.display='none';
    vib(45);
  },g.reload*1000);
}

// =============================================
// WIN CHECK
// =============================================
function checkWin(){
  const alive=enemies.some(uid=>players[uid]&&players[uid].alive);
  if(!alive&&!gone){
    gameCh.send({type:'broadcast',event:'go',payload:{wt:myTeam}});
    endGame('win');
  }
}

// =============================================
// SCOPE & MIC
// =============================================
function togScope(){
  tap();vib(20);scopeOn=!scopeOn;
  document.getElementById('scopeEl').classList.toggle('on',scopeOn);
  document.getElementById('scopeBtn').classList.toggle('on',scopeOn);
}

function togMic(){
  tap();vib(20);micOn=!micOn;
  if(localStream)localStream.getAudioTracks().forEach(t=>t.enabled=micOn);
  const b=document.getElementById('micBtn');
  b.textContent=micOn?'üé§':'üîá';
  b.classList.toggle('spk',micOn);
}

// =============================================
// HUD ADJUST
// =============================================
function adjHUD(dir){
  tap();vib(15);
  if(dir===1)hudScale=Math.min(1.4,hudScale+.1);
  else if(dir===-1)hudScale=Math.max(.7,hudScale-.1);
  else hudAlpha=hudAlpha<.5?1:hudAlpha-.2;
  const bh=document.getElementById('bhud');
  bh.style.opacity=hudAlpha;
  bh.style.transform=`scale(${hudScale})`;
  bh.style.transformOrigin='bottom center';
  document.getElementById('thud').style.opacity=hudAlpha;
}

// =============================================
// TIMER
// =============================================
function startTimer(){
  timerInt=setInterval(()=>{
    timeLeft--;
    const m=Math.floor(timeLeft/60),s=timeLeft%60;
    const el=document.getElementById('gTimer');
    el.textContent=m+':'+(s<10?'0':'')+s;
    el.classList.toggle('d',timeLeft<=30);
    if(timeLeft<=0){clearInterval(timerInt);endGame('timeout');}
  },1000);
}

// =============================================
// COUNTDOWN
// =============================================
function startCD(){
  let n=3;const el=document.getElementById('cdn');
  const iv=setInterval(()=>{
    n--;
    if(n<=0){
      clearInterval(iv);
      document.getElementById('sovl').classList.add('h');
      started=true;startTimer();
    } else {
      el.textContent=n;
      el.style.animation='none';
      setTimeout(()=>el.style.animation='cdp 1s ease-out',10);
      vib(60);
    }
  },1000);
}

// =============================================
// GAME OVER
// =============================================
async function endGame(res){
  if(gone&&res!=='win'&&res!=='lose'&&res!=='timeout')return;
  gone=true;
  clearInterval(timerInt);clearInterval(posInt);clearInterval(autoFInt);
  if(gameCh)supabase.removeChannel(gameCh);

  let won;
  if(res==='timeout'){
    const alivE=enemies.filter(u=>players[u]&&players[u].alive).length;
    won=alivE===0;
  } else won=res==='win';

  const coins=won?200+kills*50:50+kills*15;
  vib(won?[100,50,200]:[200,100,50]);

  document.getElementById('goIc').textContent=won?'üèÜ':'üíÄ';
  const gt=document.getElementById('goT');
  gt.textContent=won?'VICTORY!':'DEFEATED';
  gt.className='go-t '+(won?'w':'l');
  document.getElementById('gDmg').textContent=dmgTotal;
  document.getElementById('gKill').textContent=kills;
  document.getElementById('gHS').textContent=hsCount;
  document.getElementById('gCoin').textContent=coins;
  document.getElementById('goscreen').classList.add('show');

  // Update DB
  try{
    const{data:cur}=await supabase.from('players').select('total_matches,wins,kills,coins').eq('id',myUid).single();
    if(cur){
      await supabase.from('players').update({
        total_matches:(cur.total_matches||0)+1,
        wins:(cur.wins||0)+(won?1:0),
        kills:(cur.kills||0)+kills,
        coins:(cur.coins||0)+coins
      }).eq('id',myUid);
    }
    await supabase.from('rooms').update({status:'finished'}).eq('room_id',roomId);
  }catch(e){console.log(e);}
}

function goLobby(){
  tap();
  const v=document.getElementById('cam');
  if(v.srcObject)v.srcObject.getTracks().forEach(t=>t.stop());
  if(localStream)localStream.getTracks().forEach(t=>t.stop());
  localStorage.removeItem('rb_room');
  window.location.href='home.html';
}

// UI HELPERS
function showDmgN(dmg,isHead){
  const e=document.createElement('div');
  e.className='dnum '+(isHead?'h':'n');
  e.textContent=(isHead?'üéØ ':'')+dmg;
  e.style.left=(32+Math.random()*22)+'%';
  e.style.top=(28+Math.random()*14)+'%';
  document.body.appendChild(e);
  setTimeout(()=>e.remove(),1200);
}

function addKF(msg,good){
  const f=document.getElementById('kfeed');
  const d=document.createElement('div');
  d.className='kf '+(good?'ok':'bad');
  d.textContent=msg; f.appendChild(d);
  setTimeout(()=>d.remove(),3000);
  while(f.children.length>5)f.removeChild(f.firstChild);
}

function addChat(un,txt){
  const w=document.getElementById('chatbox');
  const d=document.createElement('div');
  d.className='cm';
  d.innerHTML=`<span class="cm-n">${un}:</span> ${txt}`;
  w.appendChild(d);
  setTimeout(()=>d.remove(),5000);
  while(w.children.length>5)w.removeChild(w.firstChild);
}

// Prevent scroll on game screen
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
</script>
</body>
</html>

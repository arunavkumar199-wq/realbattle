<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1">
<meta name="theme-color" content="#FF6B00">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>RealBattle - Login</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{min-height:100vh;display:flex;align-items:center;justify-content:center;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:linear-gradient(135deg,#0a0a1a 0%,#1a1a3a 100%);overflow:hidden;color:#fff}
.bg{position:fixed;inset:0;z-index:0;opacity:0.3;
  background:radial-gradient(circle at 20% 80%,#ff6b00 0%,transparent 40%),
             radial-gradient(circle at 80% 20%,#ff4500 0%,transparent 40%)}
.wrap{position:relative;z-index:10;width:92%;max-width:400px}
.logo{text-align:center;margin-bottom:28px}
.logo h1{font-size:42px;font-weight:800;letter-spacing:3px;
  background:linear-gradient(135deg,#ff6b00,#ff4500);-webkit-background-clip:text;
  -webkit-text-fill-color:transparent}
.logo p{color:#666;font-size:11px;letter-spacing:2px;margin-top:4px}
.card{background:rgba(15,15,35,0.95);border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;padding:24px 20px;backdrop-filter:blur(10px);
  box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.tabs{display:flex;background:rgba(10,10,25,0.8);border-radius:12px;
  padding:4px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.08)}
.tb{flex:1;padding:10px;text-align:center;border-radius:9px;
  cursor:pointer;font-size:13px;font-weight:600;color:#666;transition:all 0.2s}
.tb.on{background:linear-gradient(135deg,#ff6b00,#ff4500);color:#fff;
  box-shadow:0 4px 12px rgba(255,107,0,0.3)}
.fg{margin-bottom:14px}
.fg label{display:block;color:#888;font-size:10px;letter-spacing:1px;
  margin-bottom:6px;font-weight:500;text-transform:uppercase}
.fg input{width:100%;background:rgba(10,10,25,0.8);border:1px solid rgba(255,255,255,0.12);
  border-radius:12px;padding:14px 16px;color:#fff;font-size:15px;outline:none;
  transition:all 0.2s}
.fg input:focus{border-color:#ff6b00;box-shadow:0 0 0 3px rgba(255,107,0,0.15)}
.btn{width:100%;padding:16px;margin-top:8px;
  background:linear-gradient(135deg,#ff6b00,#ff4500);border:none;border-radius:13px;
  color:#fff;font-size:15px;font-weight:700;cursor:pointer;
  box-shadow:0 6px 20px rgba(255,107,0,0.35);transition:transform 0.15s}
.btn:active{transform:scale(0.98)}
.btn:disabled{opacity:0.6;cursor:not-allowed}
.msg{margin-top:12px;padding:12px;border-radius:10px;font-size:13px;
  text-align:center;display:none}
.msg.err{background:rgba(255,50,50,0.15);border:1px solid rgba(255,50,50,0.3);color:#ff8888;display:block}.msg.ok{background:rgba(0,220,100,0.15);border:1px solid rgba(0,220,100,0.3);color:#88ffcc;display:block}
.ld{display:none;text-align:center;margin-top:10px;color:#ff6b00;font-size:12px}
.sp{display:inline-block;width:14px;height:14px;border:2px solid #333;
  border-top:2px solid #ff6b00;border-radius:50%;animation:spin 0.7s linear infinite;margin-right:6px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.ver{text-align:center;color:#333;font-size:10px;margin-top:16px;letter-spacing:1px}
</style>
</head>
<body>
<div class="bg"></div>
<div class="wrap">
  <div class="logo">
    <h1>âš” REALBATTLE</h1>
    <p>REAL WORLD AR BATTLE â€¢ INDIA</p>
  </div>
  <div class="card">
    <div class="tabs">
      <div class="tb on" id="tL" onclick="sw('login')">LOGIN</div>
      <div class="tb" id="tR" onclick="sw('reg')">REGISTER</div>
    </div>
    
    <!-- LOGIN FORM -->
    <div id="fL">
      <div class="fg">
        <label>USERNAME</label>
        <input id="lU" type="text" placeholder="Enter username" autocomplete="username" inputmode="text">
      </div>
      <div class="fg">
        <label>PASSWORD</label>
        <input id="lP" type="password" placeholder="Enter password" autocomplete="current-password">
      </div>
      <button class="btn" id="bL" onclick="doLogin()">âš” ENTER BATTLE</button>
    </div>
    
    <!-- REGISTER FORM -->
    <div id="fR" style="display:none">
      <div class="fg">
        <label>USERNAME</label>
        <input id="rU" type="text" placeholder="3-18 chars, letters/numbers only" maxlength="18" autocomplete="username" inputmode="text">
      </div>
      <div class="fg">
        <label>EMAIL</label>
        <input id="rE" type="email" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="fg">
        <label>PASSWORD</label>
        <input id="rP" type="password" placeholder="Min 6 characters" autocomplete="new-password">
      </div>
      <button class="btn" id="bR" onclick="doReg()">ðŸ”¥ CREATE ACCOUNT</button>
    </div>    
    <div class="msg" id="msg"></div>
    <div class="ld" id="ld"><span class="sp"></span>Please wait...</div>
  </div>
  <p class="ver">v1.1 â€¢ Mobile Optimized â€¢ Zero Lag</p>
</div>

<script>
// ===== UI FUNCTIONS =====
function sw(t){
  tap();vib(20);
  const isL=t==='login';
  document.getElementById('fL').style.display=isL?'block':'none';
  document.getElementById('fR').style.display=isL?'none':'block';
  document.getElementById('tL').classList.toggle('on',isL);
  document.getElementById('tR').classList.toggle('on',!isL);
  clrMsg();
}

function showMsg(m,t){
  const e=document.getElementById('msg');
  e.textContent=m;e.className='msg '+t;
  setTimeout(()=>{if(e.className.includes(t))clrMsg()},4000);
}
function clrMsg(){document.getElementById('msg').className='msg'}
function setLd(on,bid){
  document.getElementById('ld').style.display=on?'block':'none';
  document.getElementById(bid).disabled=on;
}

// ===== REGISTER =====
async function doReg(){
  tap();vib(25);
  const u=document.getElementById('rU').value.trim();
  const e=document.getElementById('rE').value.trim();
  const p=document.getElementById('rP').value;
  
  // Validation
  if(!u||!e||!p){showMsg('âš  All fields required','err');return}
  if(u.length<3){showMsg('âš  Username min 3 chars','err');return}
  if(!/^[a-zA-Z0-9_]+$/.test(u)){showMsg('âš  Only letters, numbers, _ allowed','err');return}
  if(p.length<6){showMsg('âš  Password min 6 chars','err');return}
  if(!e.includes('@')){showMsg('âš  Valid email required','err');return}
  
  setLd(true,'bR');
  
  try{
    // Check username availability FIRST
    const{data:ex,error:exErr}=await supabase
      .from('players')      .select('username')
      .eq('username',u)
      .maybeSingle();
    
    if(exErr) throw exErr;
    if(ex){showMsg('âŒ Username taken! Try another','err');setLd(false,'bR');return}
    
    // Create auth user
    const{data:authData,error:authErr}=await supabase.auth.signUp({
      email:e,
      password:p,
      options:{
        data:{username:u},
        emailRedirectTo:window.location.origin+'/home.html'
      }
    });
    
    if(authErr) throw authErr;
    if(!authData.user){showMsg('âŒ Signup failed. Try again','err');setLd(false,'bR');return}
    
    // Create player profile
    const{error:profErr}=await supabase.from('players').upsert({
      id:authData.user.id,
      username:u,
      email:e,
      coins:500,
      selected_guns:['desert','m1887','ump']
    },{onConflict:'id'});
    
    if(profErr) throw profErr;
    
    showMsg('âœ… Account created! Login karo','ok');
    vib([60,30,80]);
    setTimeout(()=>sw('login'),1800);
    
  }catch(err){
    console.error('Reg error:',err);
    showMsg('âŒ '+(err.message||'Error. Try again.'),'err');
  }
  setLd(false,'bR');
}

// ===== LOGIN =====
async function doLogin(){
  tap();vib(25);
  const u=document.getElementById('lU').value.trim();
  const p=document.getElementById('lP').value;
  
  if(!u||!p){showMsg('âš  Fill all fields','err');return}
  setLd(true,'bL');  
  try{
    // Get email from username
    const{data:pl,error:plErr}=await supabase
      .from('players')
      .select('email,id')
      .eq('username',u)
      .maybeSingle();
    
    if(plErr) throw plErr;
    if(!pl){showMsg('âŒ Username not found','err');setLd(false,'bL');return}
    
    // Sign in
    const{data:authData,error:authErr}=await supabase.auth.signInWithPassword({
      email:pl.email,
      password:p
    });
    
    if(authErr) throw authErr;
    if(!authData.user){showMsg('âŒ Wrong password','err');setLd(false,'bL');return}
    
    // Save session
    localStorage.setItem('rb_uid',authData.user.id);
    localStorage.setItem('rb_un',u);
    
    showMsg('âœ… Welcome '+u+'!','ok');
    vib([50,30,100]);
    
    // Redirect to home
    setTimeout(()=>{
      window.location.href='home.html';
    },800);
    
  }catch(err){
    console.error('Login error:',err);
    showMsg('âŒ '+(err.message||'Login failed'),'err');
  }
  setLd(false,'bL');
}

// ===== UTILS =====
document.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  if(document.getElementById('fL').style.display!=='none')doLogin();
  else doReg();
});

// Check if already logged in
window.addEventListener('load',async()=>{
  try{    const{data:{session}}=await supabase.auth.getSession();
    if(session?.user){
      const{data:pl}=await supabase.from('players').select('username').eq('id',session.user.id).maybeSingle();
      if(pl){
        localStorage.setItem('rb_uid',session.user.id);
        localStorage.setItem('rb_un',pl.username);
        window.location.href='home.html';
      }
    }
  }catch(e){console.log('Session check:',e)}
});
</script>
</body>
</html>
